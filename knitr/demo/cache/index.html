<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Cache - Examples for the cache feature  - Yihui Xie | 谢益辉</title>
    <meta property="og:title" content="Cache - Yihui Xie | 谢益辉">
    
    <meta name="twitter:card" content="summary">

    
      
    

    
      
      <meta property="description" content="We can use the chunk option cache=TRUE to enable cache, and the option cache.path can be used to set the cache directory. See the options page.
[&amp;hellip;] The cache feature is used extensively in many &amp;hellip;">
      <meta property="og:description" content="We can use the chunk option cache=TRUE to enable cache, and the option cache.path can be used to set the cache directory. See the options page.
[&amp;hellip;] The cache feature is used extensively in many &amp;hellip;">
      
    

    
    
    
    <meta name="twitter:image" content="https://yihui.name/images/logo.png">
    
    

    

    
    


<link href='//cdn.bootcss.com/highlight.js/9.12.0/styles/github.min.css' rel='stylesheet' type='text/css' />



    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
<link rel="stylesheet" href="/css/custom.css" />

  </head>

  
  <body class="knitr">
    <header class="masthead">
      

<h1><a href="/knitr/"><img src="/knitr/images/knit-logo.png" alt="knitr logo" /></a></h1>
<p class="tagline">knitr: elegant, flexible, and fast dynamic report generation with R</p>


      <nav class="menu">
  <ul>
  
  
  <li><a href="/knitr/">Home</a></li>
  
  <li><a href="/knitr/options/">Options</a></li>
  
  <li><a href="/knitr/hooks/">Hooks</a></li>
  
  <li><a href="/knitr/demos/">Examples</a></li>
  
  <li><a href="/knitr/faq/">FAQ</a></li>
  
  <li><a href="https://github.com/yihui/knitr">Github repo</a></li>
  
  <li><a href="/">Yihui Xie</a></li>
  
  

<li class="menu-extra"></li>



<li><a href="https://github.com/rbind/yihui/edit/master/content/knitr%5cdemo%5c2011-12-04-cache.md" target="_blank">Edit this page</a></li>


<li><a href="/knitr/index.xml" type="application/rss+xml" title="RSS feed">Subscribe</a></li>

<li><a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="Attribution-NonCommercial-ShareAlike 4.0 International">License</a></li>


  </ul>
</nav>

    </header>

    <article class="main">
      <header class="title">
      
<h1>Cache</h1>
<h1><span class="subtitle">Examples for the cache feature</span></h2>

<h3>
2011-12-04</h3>

<hr>


      </header>





<p>We can use the chunk option <code>cache=TRUE</code> to enable cache, and the option <code>cache.path</code> can be used to set the cache directory. See the <a href="../../options/">options</a> page.</p>

<h2 id="cache-examples">Cache examples</h2>

<p>The cache feature is used extensively in many of my documents, e.g. you can find it in the <strong>knitr</strong> <a href="../manual/">main manual</a> or its <a href="http://yihui.name/knitr/demo/graphics/">graphics manual</a>. Here are a few more examples:</p>

<ul>
<li>basic examples

<ul>
<li>cache large data: <a href="https://github.com/yihui/knitr-examples/raw/master/056-huge-plot.Rmd">056-huge-plot.Rmd</a> (<a href="https://github.com/yihui/knitr-examples/blob/master/056-huge-plot.md">output</a>)</li>
<li>an example using the Rtex syntax: <a href="https://github.com/yihui/knitr/blob/master/inst/examples/knitr-latex.Rtex">knitr-latex.Rtex</a></li>
</ul></li>
<li>automatic dependencies

<ul>
<li>Rnw source: <a href="https://github.com/yihui/knitr-examples/blob/master/017-auto-dependson.Rnw">knitr-dependson.Rnw</a></li>
<li>with the chunk option <code>autodep=TRUE</code> and the function <code>dep_auto()</code>, <strong>knitr</strong> can figure out the dependencies among chunks automatically, which may save some manual efforts to specify the <code>dependson</code> option</li>
</ul></li>
</ul>

<h2 id="important-notes">Important notes</h2>

<p>You have to read the section on cache in the <a href="https://github.com/yihui/knitr/releases/download/doc/knitr-manual.pdf">main manual</a> very carefully to understand when cache will be rebuilt and which chunks should not be cached.</p>

<p>Let me repeat the three factors that can affect cache (any change on them will invalidate old cache):</p>

<ol>
<li>all chunk options except <code>include</code>; e.g. change <code>tidy=TRUE</code> to <code>FALSE</code> will break the old cache, but changing <code>include</code> will not</li>
<li>R code in a chunk; a tiny change in the R code will lead to removal of old cache, even if it is a change of a space or a blank line</li>
<li>the R option <code>width</code> (<code>getOption('width')</code>)</li>
</ol>

<p>It is extremely important to note that usually a chunk that has side-effects should <em>not</em> be cached. Although <strong>knitr</strong> tries to retain the side-effects from <code>print()</code>, there are still other side-effects that are not preserved. Here are some cases that you must not use cache for a chunk:</p>

<ol>
<li>setting R options like <code>options('width')</code> or <code>pdf.options()</code> or any other options in <strong>knitr</strong> like <code>opts_chunk$set()</code>, <code>opts_knit$set()</code> and <code>knit_hooks$set()</code></li>
<li>loading packages via <code>library()</code> in a cached chunk and these packages will be used by uncached chunks (it is entirely OK to load packages in a cached chunk and use them only in cached chunks because <strong>knitr</strong> saves the list of packages for cached chunks, but uncached chunks are unable to know which packages are loaded in previous cached chunks)</li>
</ol>

<p>Otherwise next time the chunk will be skipped and all the settings in it will be ignored. You have to use <code>cache=FALSE</code> explicitly for these chunks.</p>

<p>The functions <code>source()</code> and <code>setGeneric()</code> have side effects of creating objects in the global environment even if the code is evaluated in a local environment. Before <strong>knitr</strong> v0.4, it was unable to cache these global objects (e.g. issue <a href="https://github.com/yihui/knitr/issues/138">#138</a>), but since v0.4, they can be cached as well because <strong>knitr</strong> checks newly created objects in <code>globalenv()</code> and save them as well.</p>

<p>Although the list of packages used in cached chunks is saved, this is not a perfect way of caching package names: if you loaded a package but removed it later, <strong>knitr</strong> will be unable to know it (<strong>knitr</strong> is only able to capture newly loaded packages). You have to manually edit the <code>__packages</code> file under the cache directory as described in <a href="https://github.com/yihui/knitr/issues/382">#382</a>.</p>

<h2 id="even-more-stuff-for-cache">Even more stuff for cache?</h2>

<p>While the above objects seem reasonable to affect cache, reproducible research may be even more rigorous in the sense that cache can be invalidated by other changes. One typical example is the version of software; it is not impossible for two different versions of R to give you different results. In this case, we may set</p>

<pre><code class="language-r">opts_chunk$set(cache.extra = R.version.string)
opts_chunk$set(cache.extra = R.version) # or even consider platform
</code></pre>

<p>so the cached results are only applicable to a specific version of R. When you upgrade R and recompile the document, all the results will be re-computed.</p>

<p>Similarly you can put more variables into this option so that the cache is preserved only given environments. Here is an ambitious example:</p>

<pre><code class="language-r">## cache is only valid with a specific version of R and session info
## cache will be kept for at most a month (re-compute the next month)
opts_chunk$set(cache.extra = list(
  R.version, sessionInfo(), format(Sys.Date(), '%Y-%m')
))
</code></pre>

<p>The issue <a href="https://github.com/yihui/knitr/issues/238">#238</a> shows another good use of this option: the cache is associated with the file modification time, i.e. when the data file is modified, the cache will be rebuilt automatically.</p>

<p>Note you can actually use any option name other than <code>cache.extra</code> to introduce more objects into the cache condition, e.g. you can call it <code>cache.validation</code>. The reason is that all chunk options are taken into account when validating the cache.</p>

<h2 id="associate-cache-directory-with-the-input-filename">Associate cache directory with the input filename</h2>

<p>Sometimes we may want to use different cache directories for different input files by default, and there is one solution in issue <a href="https://github.com/yihui/knitr/issues/234">#234</a>. However, I still recommend you to do this setting inside your source document to make it self-contained (use <code>opts_chunk$set(cache.path = ...)</code>).</p>

<h2 id="more-granular-cache">More granular cache</h2>

<p>Besides <code>TRUE</code> and <code>FALSE</code> for the chunk option <code>cache</code>, advanced users can
also consider more granular cache by using numeric values for <code>cache = 0, 1,
2, 3</code>: <code>0</code> means <code>FALSE</code>, and <code>3</code> is equivalent to <code>TRUE</code>. For <code>cache = 1</code>,
the results of the computation (from <code>evaluate::evaluate()</code>) are loaded from
the cache, so the code is not evaluated again, but everything else is still
executed, such the output hooks and saving recorded plots to files. For
<code>cache = 2</code>, it is very similar to <code>1</code>, and the only difference is that the
recorded plots will not be resaved to files when the plot files already
exist, which might save some time when the plots are big. It is recommended
to use <code>cache = 2</code> instead of <code>1</code>, because there is no guarantee that
recorded plots in a previous R session can be safely resaved in another R
session, or using another version of R.</p>

<p>When <code>cache = 1, 2</code>, only a few chunk options affect the cache; see
<code>knitr:::cache1.opts</code> and <code>knitr:::cache2.opts</code> for the option names.
Basically, the cache will not be invalidated if a chunk option that does not
affect the code evaluation is changed. For example, we change <code>echo</code> from
<code>TRUE</code> to <code>FALSE</code>, or set <code>fig.cap = 'a new caption'</code>; however, if we change
<code>eval</code> from <code>TRUE</code> to <code>FALSE</code>, or <code>cache.path='foo/'</code> to <code>'bar/'</code>, the cache
has to be rebuilt.</p>

<p>See the <a href="https://github.com/yihui/knitr-examples/">example #101</a>
(<a href="https://github.com/yihui/knitr-examples/blob/master/101-cache-levels.md">output</a>)
for some examples.</p>

<p>In this way, we can separate the computing from document output rendering,
and it can be useful to tweak the output without breaking the cache. See
<a href="https://github.com/yihui/knitr/issues/396">#396</a> and
<a href="https://github.com/yihui/knitr/issues/536">#536</a>.</p>

<h2 id="reproducibility-with-rng">Reproducibility with RNG</h2>

<p><strong>Knitr</strong> also caches <code>.Random.seed</code> and it is restored before the evaluation of each chunk to maintain reproducibility of chunks which involve with random number generation (RNG). However, there is a problem here. Suppose chunk A and B have been cached; now if we insert a chunk C between A and B (all three chunks have RNG in them), in theory B should be updated because RNG modifies <code>.Random.seed</code> as a side-effect, but in fact B will not be updated; in other words, the reproducibility of B is bogus.</p>

<p>To guarantee reproducibility with RNG, we need to associate <code>.Random.seed</code> with cache; whenever it is modified, the chunk must be updated. It is easy to do so by using an <em>unevaluated</em> R expression in the <code>cache.extra</code> option, e.g.</p>

<pre><code class="language-r">opts_chunk$set(cache.extra = rand_seed)
</code></pre>

<p>See <code>?rand_seed</code> (it is an unevaluated R expression). In this case, each chunk will first check if <code>.Random.seed</code> has been changed since the last run; a different <code>.Random.seed</code> will force the current chunk to rebuild cache.</p>


  <footer>
  
<nav class="post-nav">
  <span class="nav-prev">&larr; <a href="/knitr/demo/minimal/">Minimal examples</a></span>
  <span class="nav-next"><a href="/knitr/demo/manual/">Manual</a> &rarr;</span>
</nav>
<script type="text/javascript">
document.addEventListener('keyup', function(e) {
  if (e.target.nodeName.toUpperCase() != 'BODY') return;
  var url = false;
  if (e.which == 37) {  
    
    url = '\/knitr\/demo\/minimal\/';
    
  } else if (e.which == 39) {  
    
    url = '\/knitr\/demo\/manual\/';
    
  }
  if (url) window.location = url;
});
</script>



<section class="comments">
  <div id="disqus_thread"></div>
  <script>
  var disqus_config = function () {
  
    this.page.url = "http:\/\/yihui.name" + location.pathname;
  
  };
  (function() {
    var inIFrame = function() {
      var iframe = true;
      try { iframe = window.self !== window.top; } catch (e) {}
      return iframe;
    };
    if (inIFrame()) return;
    var disqus_js = '//yihui.disqus.com/embed.js';
    var d = document, s = d.createElement('script');
    s.src = disqus_js; s.async = true;
    s.setAttribute('data-timestamp', +new Date());
    var b = false, l = function() {
      if (b) return;
      (d.head || d.body).appendChild(s); b = true;
    }
    
    if (location.hash.match(/^#comment/)) return(l());
    var t = d.getElementById('disqus_thread');
    var c = function() {
      if (b) return;
      var rect = t.getBoundingClientRect();
      if (rect.top < window.innerHeight && rect.bottom >= 0) l();
    };
    window.addEventListener('load', c);
    d.addEventListener('scroll', c);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>




<script async src="/js/external-link.js"></script>

<script async src="/js/center-img.js"></script>

<script async src="/js/right-quote.js"></script>

<script async src="/js/no-highlight.js"></script>

<script async src="/js/fix-footnote.js"></script>

<script async src="/js/math-code.js"></script>



<script async src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>


  



<script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>



<script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/r.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/yaml.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/tex.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



  
  <hr>
  <div class="copyright">&copy; <a href="/">Yihui Xie</a> 2005 - 2018</div>
  
  </footer>
  </article>
  
<script>
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-1988641-2', 'auto');
	
	ga('send', 'pageview');
}
</script>

  </body>
</html>

